<div class="chat-container">
    <div class="header">
        <h2>Sala: {{roomName}}</h2>
        <p>Conectado como:{{username}}</p>
    </div>

    <div class="messages-area">
        <ul id="messages">
            </ul>
    </div>

    <form id="chat-form" class="message-form">
        <input id="message-input" type="text" placeholder="Escribe tu mensaje..." required autocomplete="off">
        <button type="submit">Enviar</button>
    </form>

    <hr>

    <div class="controls">
        <button id="btn-leave-room" class="btn-secondary">
            Salir de Sala (Elegir otra)
        </button>
    </div>
</div>

<style>

    .message-mine {
        text-align: right; 
        background-color: #d1e7dd; 
        padding: 5px;
        margin: 5px 0;
        border-radius: 5px;
    }
    .message-other {
        text-align: left; 
        background-color: #f8d7da;
        padding: 5px;
        margin: 5px 0;
        border-radius: 5px;
    }
    .system-message {
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    #messages {
        list-style: none;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
    }
    .chat-container {
        max-width: 800px;
        margin: 20px auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
</style>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const USERNAME = '{{username}}';
    const ROOM_NAME = '{{roomName}}';

    const messagesList = document.getElementById('messages');
    const messageForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    socket.on('connect', () => {
        socket.emit('joinRoom', { 
            username: USERNAME, 
            room: ROOM_NAME 
        });
    });

    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();

        if (message) {
            socket.emit('chatMessage', message); 
            messageInput.value = '';
        }
    });

    socket.on('messageReceived', (data) => {
        const item = document.createElement('li');
        const isMine = data.username === USERNAME; 

        item.classList.add(isMine ? 'message-mine' : 'message-other'); 

        const time = new Date(data.timestamp).toLocaleTimeString();
        const content = `
            <span class="user-name"><b>${isMine ? 'TÃº' : data.username}</b>:</span> 
            <span class="text">${data.message}</span>
            <span class="time">${time}</span>
        `;
        item.innerHTML = content;
        messagesList.appendChild(item);
        messagesList.scrollTop = messagesList.scrollHeight;
    });

    socket.on('systemMessage', (data) => {
        const item = document.createElement('li');
        item.classList.add('system-message');
        item.textContent = data.message;
        messagesList.appendChild(item);
        messagesList.scrollTop = messagesList.scrollHeight;
    });

    document.getElementById('btn-leave-room').addEventListener('click', () => {
        socket.emit('leaveRoom');
        window.location.href = `/salas?username=${encodeURIComponent(USERNAME)}`; 
    });

    document.getElementById('btn-logout').addEventListener('click', (e) => {
        socket.emit('leaveRoom');
        sessionStorage.removeItem("Username"); 
    });
</script>